package exploit;

import model.ScheduledTask;
import mqtt.MqttConfig;
import org.eclipse.paho.client.mqttv3.MqttClient;
import org.eclipse.paho.client.mqttv3.MqttException;
import org.eclipse.paho.client.mqttv3.MqttMessage;

import java.io.ByteArrayOutputStream;
import java.io.ObjectOutputStream;

public class ExploitProducer {

    private final MqttClient client;

    public ExploitProducer() throws MqttException {
        client = new MqttClient(MqttConfig.BROKER_URL, "exploit-producer");
        client.connect();
    }

    public void publish(ScheduledTask task) throws Exception {
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(bos);
        oos.writeObject(task);

        MqttMessage msg = new MqttMessage(bos.toByteArray());
        client.publish(MqttConfig.TASK_TOPIC, msg);
    }

    public void close() {
        if (client.isConnected()) {
            try {
                client.disconnect();
                client.close();
            } catch (MqttException e) {
                throw new RuntimeException(e);
            }
        }
    }
}
